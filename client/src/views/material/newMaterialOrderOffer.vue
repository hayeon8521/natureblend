<!-- 
    Î©îÎâ¥ : ÏûêÏû¨>ÏûêÏû¨Î∞úÏ£º>ÏûêÏû¨ Î∞úÏ£º Í¥ÄÎ¶¨ [ÏûêÏû¨Ï£ºÎ¨∏ Í∑∏Î¶¨Îìú]
    ÏûêÏû¨ Î∞úÏ£º Í¥ÄÎ¶¨ Î©îÎâ¥ Î¶¨Î©îÏù¥ÌÅ¨ Ïùò BOMÍ∏∞Î∞ò Î∞úÏ£ºÏÑú Î¶¨Ïä§Ìä∏ Ïª¥Ìè¨ÎÑåÌä∏
-->
<template>
    <div>
      <h4 style="margin-bottom: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;ÏûêÏû¨Ï£ºÎ¨∏</h4>
   </div>
    <div class="grid-container" style="padding-top: 0px;">
        <ag-grid-vue
            :rowData="materialdate"
            :columnDefs="materialcolumnDefs"
            :theme="theme"
            :pagination="true"
            :paginationPageSize="50"
            @grid-ready="onReady"
            style="height: 387px;"
            rowSelection="multiple"
            :singleClickEdit="true"
            :editOnFocus="true"
            @cell-value-changed="onCellValueChanged"
            :noRowsOverlayComponent="noRowsOverlayComponent"
        >
        </ag-grid-vue>
    </div>
    <div style="display: none">
        <CustomNoRowsOverlay/>
    </div>
    <div>
        <Modal :isShowModal="isShowModal" :modalTitle="'ÏûêÏû¨ÏÑ†ÌÉù'" :noBtn="'Îã´Í∏∞'" :yesBtn="'ÏÑ†ÌÉù'" @closeModal="closeModal" @confirm="confirm">
            <template v-slot:list>
                <matelList v-show="isShowModal" @selectmaterial="confirm" />
            </template>
        </Modal>
    </div>
    <flat-pickr
    class="form-control custom-input"
    placeholder="üìÖ  "
    v-model="selectedDate"
    :config="dateConfig"
  />
</template>
<script>
import theme from "@/utils/agGridTheme";
import CustomNoRowsOverlay from "@/views/natureBlendComponents/grid/noDataMsg.vue";
import Modal from "@/views/material/newMaterialOrderOfferMomModal.vue";
import matelList from "@/views/material/newMaterialOrderOfferModal.vue";

//Îã¨Î†•!!!!!!!!
// eslint-disable-next-line vue/no-unused-components
//import FlatPickrCellRenderer from '@/views/material/FlatPickrCellRenderer.vue';

export default {
    //Ïª¥Ìè¨ÎÑåÌä∏ ÏÑ†Ïñ∏ÌñàÏñ¥
    components: {
        CustomNoRowsOverlay,
        Modal,
        matelList,
        //FlatPickrCellRenderer,    //Îã¨Î†• Îä•Î†•Î∂ÄÏ°±ÏúºÎ°ú Ïã§Ìå®
    },
    //ÏóÑÎßàÍ∞Ä Ï£ºÎäî Îç∞Ïù¥ÌÑ∞ Î∞õÏùÑÍ∫º
    props: {
        planMaterialList: {
            type: Array,  //Î∞õÎäî ÌÉÄÏûÖ
            required: true, //ÏóÑÎßà Í∞íÏù¥Ïó¨ÏïºÌï®
            default: () => [],  //Í∞íÏóÜÏùÑÎïå Í∏∞Î≥∏ Í∞í []
        },
        clientList: {
            type: Array,  //Î∞õÎäî ÌÉÄÏûÖ
            required: true, //ÏóÑÎßà Í∞íÏù¥Ïó¨ÏïºÌï®
            default: () => [],  //Í∞íÏóÜÏùÑÎïå Í∏∞Î≥∏ Í∞í [] 
        },
    },
    // ÎÑê Í≥ÑÏÜç Í∞êÏãúÌï†Í∫ºÏïº
    watch: {
        planMaterialList: {
            //Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞ÌôîÏö© Ìï∏Îì§Îü¨
            handler(newList){
                this.materialdate = newList.map((item) => ({
                    ...item, // Í∏∞Ï°¥ item Î≥µÏÇ¨
                }));
            },
            // ÎÑå ÏµúÏ¥à 1Ìöå Ïñ¥Îñ§ÏùºÏù¥ ÏûàÏñ¥ÎèÑ ÏûëÎèôÌï¥ÏïºÌï¥
            immediate: true, 
        },
        clientList:{
            handler(clients){
                if (clients.length) {
                    this.clientdata = clients.map((item) => ({
                        ...item, // Í∏∞Ï°¥ item Î≥µÏÇ¨
                    }));
                    this.poListSum();
                }
            },
            immediate: true, 
        },
    },
    //Î≥ÄÏàò ÎÑ£Îäî ÌÜµÏùÄ ÎÑàÏïº
    data(){
        return{
            isShowModal: false, //Î™®Îã¨ Í∏∞Î≥∏ Ïà®Í≤®Ïßê
            noRowsOverlayComponent: 'CustomNoRowsOverlay',
            materialcolumnDefs: [
                { 
                    headerCheckboxSelection: true,
                    checkboxSelection: true,
                    headerName: "",
                    flex:1,
                },
                { headerName: "ÏûêÏû¨ÏΩîÎìú", field: "material_code", flex:3, cellStyle: { textAlign: "center" } },
                { headerName: "ÏûêÏû¨Î™Ö", field: "material", flex:4, cellStyle: { textAlign: "left" } },
                { headerName: "ÏûêÏû¨Ïû¨Í≥†", field: "stok_qty", flex:3, cellStyle: { textAlign: "right" } },
                { headerName: "ÏïàÏ†ÑÏû¨Í≥†", field: "safety_inventory", flex:3, cellStyle: { textAlign: "right" } },
                { headerName: "Í≥ÑÌöçÏû¨Í≥†", field: "plan_qty", flex:3, cellStyle: { textAlign: "right" } },
                { headerName: "Î∞úÏ£ºÏû¨Í≥†", field: "ordering_qty", flex:3, cellStyle: { textAlign: "right" } },
                { headerName: "ÌïÑÏöîÏàòÎüâ", field: "need_qty", flex:3, cellStyle: { textAlign: "right" } },
                {  
                    headerName: "Í±∞ÎûòÏ≤ò", 
                    flex:3,
                    cellStyle: { textAlign: "center" },
                    field: "ÏÑ†ÌÉù", 
                    editable: false,
                    cellRenderer: params => {
                        const div = document.createElement('div');
                        div.style.display = 'flex';
                        div.style.justifyContent = 'center';
                        div.style.alignItems = 'center';
                        div.style.height = '100%';
                        
                        const clientButton = document.createElement('button');
                        clientButton.innerText = 'ÏÑ†ÌÉùÌïòÍ∏∞';
                        clientButton.style.cursor = 'pointer';
                        clientButton.style.backgroundColor = '#4caf50';
                        clientButton.style.width = '60px';
                        clientButton.style.height = '30px';
                        clientButton.style.color = 'white';
                        clientButton.style.border = 'none';
                        clientButton.style.borderRadius = '4px';
                        clientButton.style.display = 'flex';
                        clientButton.style.justifyContent = 'center';
                        clientButton.style.alignItems = 'center';
                        clientButton.addEventListener('click', () => {
                            //console.log("Î†àÏΩîÎìú ÌôïÏù∏ : ", JSON.stringify(params.data));

                            //ÏóÑÎßàÌïúÌÖå ÌÅ¥Î¶≠Ìïú ÎÇ¥Ïö© ÎçòÏßÄÍ∏∞
                            this.$emit('seachClient', params.data.material_code, params.data.material);
                        });
                        div.appendChild(clientButton);
                        return div;
                    }
                },
                { headerName: "Í±∞ÎûòÏ≤òÎ™Ö", field: "com_name", flex:4, cellStyle: { textAlign: "left" } },
                { headerName: "Î∞úÏ£ºÎüâ", field: "go_qty", flex:3, editable: true, 
                    cellStyle: { 
                        //backgroundColor: "#fff", // Ïó∞Ìïú Î∞∞Í≤ΩÏÉâ
                        //border: "0.5px dashed #fb8c00", // Ï†êÏÑ† ÌÖåÎëêÎ¶¨
                        cursor: "text", // ÌÖçÏä§Ìä∏ Ïª§ÏÑú
                        textAlign: "right",
                    },
                    cellRenderer: params => {
                        if (params.value) {
                            if(params.data.material.includes('Î≥ë')){
                                const formatted_qty = params.value.toLocaleString()+' Í∞ú';
                                return `<span style="text-align: right;">${formatted_qty}</span>`;
                            }else{
                                const formatted_qty = params.value.toLocaleString()+' kg';
                                return `<span style="text-align: right;">${formatted_qty}</span>`;
                            }
                        } else {
                            //return `<span style="text-align: left;"><img src="http://yeonsus.com/academy/cell-modify-icon.png" width=15 height=15 /></span>`;
                            return `<span style="display: flex; align-items: center; justify-content: flex-start; height: 100%;"><i class="fas fa-edit" style="color: #6c757d88"></i></span>`;
                            // return `
                            // <span style="display: flex; align-items: center; justify-content: flex-end;">
                            //     <span style="flex-grow: 1; text-align: left;"></span>
                            //     <i class="fas fa-edit" style="color: gray" title="ÎçîÌÅ¥ÌÅ¥Î¶≠ÌïòÏó¨ ÏàòÏ†ïÌï¥Ï£ºÏÑ∏Ïöî."></i>
                            // </span>
                            // `;
                        }
                    },
                },
                { headerName: "Îã®Í∞Ä", field: "go_price", flex:3, editable: true, 
                    cellStyle: { 
                        //backgroundColor: "#fff",
                        //border: "0.5px dashed #fb8c00",
                        cursor: "text",
                        textAlign: "right",
                    },
                    cellRenderer: params => {
                        if (params.value) {
                            const formatted_price = params.value.toLocaleString()+' Ïõê';
                            return `<span style="text-align: right;">${formatted_price}</span>`;
                        } else {
                            //return `<span style="text-align: left;"><img src="http://yeonsus.com/academy/cell-modify-icon.png" width=15 height=15 /></span>`;
                            return `<span style="display: flex; align-items: center; justify-content: flex-start; height: 100%;"><i class="fas fa-edit" style="color: #6c757d88"></i></span>`;
                        }
                    },
                },
                { headerName: "Ï¥ùÍ∏àÏï°", field: "go_total_price", flex:3,
                    cellStyle: { 
                        textAlign: "right" 
                    },
                    cellRenderer: params => {
                        if (params.value) {
                            const formatted_total_price = params.value.toLocaleString()+' Ïõê';
                            return `<span style="text-align: right;">${formatted_total_price}</span>`;
                        } else {
                            return `<span style="text-align: right;"></span>`;
                        }
                    }, 
                },
                // {
                //     headerName: "ÎÇ©Í∏∞Ïùº",
                //     field: "limit_date",
                //     width: 130,
                //     editable: true,
                //     cellRendererFramework: FlatPickrCellRenderer, // Vue Ïª¥Ìè¨ÎÑåÌä∏Î•º Î†åÎçîÎü¨Î°ú ÏÇ¨Ïö©
                // },
                { headerName: "ÎÇ©Í∏∞Ïùº", field: "limit_date", flex:3, editable: true, cellEditor: 'agDateCellEditor', 
                    cellStyle: { 
                        //backgroundColor: "#fff",
                        //border: "0.5px dashed #fb8c00",
                        cursor: "text",
                        textAlign: "right",
                    },
                    cellRenderer: params => {
                        if (params.value) {
                            const date = new Date(params.value);
                            if (isNaN(date.getTime())) return params.value;
                            const formattedDate = date.toISOString().split('T')[0];
                            return `<span style="text-align: right;">${formattedDate}</span>`;
                        } else {
                            return `<span style="text-align: right;"><i class="far fa-calendar-alt" style="color: #6c757d88"></i></span>`;
                        }
                    },
                    cellEditorParams: {
                        dateFormat: 'yyyy-MM-dd',
                    },
                    valueFormatter: (params) => {
                        if (!params.value) return '';
                        // Í∞íÏù¥ ISO Î¨∏ÏûêÏó¥ ÌòïÏãùÏù¥Î©¥ YYYY-MM-DD ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
                        const date = new Date(params.value);
                        if (isNaN(date.getTime())) return params.value; // ÎÇ†ÏßúÍ∞Ä ÏïÑÎãàÎ©¥ ÏõêÎûò Í∞í Î∞òÌôò
                        return date.toISOString().split('T')[0];
                    },
                },
                {  
                    headerName: "Î∞úÏ£ºÏ†úÍ±∞", 
                    field: "ÌñâÏÇ≠Ï†ú", 
                    editable: false,
                    flex:3,
                    cellStyle: { textAlign: "center" },
                    cellRenderer: params => {
                        const div = document.createElement('div');
                        div.style.display = 'flex';
                        div.style.justifyContent = 'center';
                        div.style.alignItems = 'center';
                        div.style.height = '100%';
                        
                        const deleteButton = document.createElement('button');
                        deleteButton.innerText = 'Ï£ºÎ¨∏ÏÇ≠Ï†ú';
                        deleteButton.style.cursor = 'pointer';
                        deleteButton.style.backgroundColor = '#f44335';
                        deleteButton.style.width = '60px';
                        deleteButton.style.height = '30px';
                        deleteButton.style.color = 'white';
                        deleteButton.style.border = 'none';
                        deleteButton.style.borderRadius = '4px';
                        deleteButton.style.display = 'flex';
                        deleteButton.style.justifyContent = 'center';
                        deleteButton.style.alignItems = 'center';
                        deleteButton.addEventListener('click', () => {
                            //console.log("Î†àÏΩîÎìú ÌôïÏù∏ : ", JSON.stringify(params.data));
                            console.log(params.data.com_name);
                            if(!params.data.com_name){
                                //console.log('Ïó¨Í∏∞Ïïº? Ïò¥');
                                this.materialdate = this.materialdate.filter(function(val){
                                    return val.material_code !== params.data.material_code;
                                });
                            }else{
                                //console.log('Ï†ïÏÉÅ Ïò¥');
                                this.materialdate = this.materialdate.filter(function(val) {
                                    return !(val.material_code === params.data.material_code && val.com_name === params.data.com_name);
                                });
                            }
                        });
                        div.appendChild(deleteButton);
                        return div;
                    }
                },
            ],
            materialdate: [],
            clientdata: [],
            theme : theme,
        };
    },
    methods: {        
        onReady(event) {
            this.gridApi = event.api;
            //event.api.sizeColumnsToFit(); //Í∑∏Î¶¨Îìú api ÎÑìÏù¥ Ïä¨ÎùºÏù¥Îìú ÏïàÏÉùÍ∏∞Í≤åÌïòÎäîÍ±∞

            // ÌéòÏù¥Ïßï ÏòÅÏó≠Ïóê Î≤ÑÌäº ÎßåÎì§Í∏∞
            const allPanels = document.querySelectorAll('.ag-paging-panel');
            const paginationPanel2 = allPanels[2];
            if (paginationPanel2) {
                const button2 = document.createElement('button');
                button2.textContent = 'Î∞úÏ£ºÏßÑÌñâ';
                button2.style.marginRight = '10px';
                button2.style.cursor = 'pointer';
                button2.style.backgroundColor = '#4caf50';
                button2.style.color = 'white';
                button2.style.border = 'none';
                button2.style.padding = '5px 10px';
                button2.style.borderRadius = '4px';
                button2.style.position = 'absolute';
                button2.style.left = '10px';

                // Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
                button2.addEventListener('click', () => {
                    console.log('Î∞úÏ£ºÏßÑÌñâ Î≤ÑÌäº ÌÅ¥Î¶≠');
                    this.allInput2();
                });

                paginationPanel2.insertBefore(button2, paginationPanel2.firstChild);


                const button3 = document.createElement('button');
                button3.textContent = 'Í∞úÎ≥ÑÏ£ºÎ¨∏';
                button3.style.marginRight = '10px';
                button3.style.cursor = 'pointer';
                button3.style.backgroundColor = '#0077ff';
                button3.style.color = 'white';
                button3.style.border = 'none';
                button3.style.padding = '5px 10px';
                button3.style.borderRadius = '4px';
                button3.style.position = 'absolute';
                button3.style.left = '100px';

                // Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
                button3.addEventListener('click', () => {
                    console.log('Í∞úÎ≥ÑÏ£ºÎ¨∏ Î≤ÑÌäº ÌÅ¥Î¶≠');
                    this.isShowModal = !this.isShowModal;
                    console.log(this.isShowModal);
                });

                paginationPanel2.insertBefore(button3, paginationPanel2.firstChild);
            }
        },
        //Î™®Îã¨ Ï∑®ÏÜåÎ≤ÑÌäº
        closeModal() {
            this.isShowModal = false;
        },
        //Î™®Îã¨ ÌôïÏù∏Î≤ÑÌäº
        confirm(data) {
            console.log('Î™®Îã¨ÌôïÏù∏', data);
            this.closeModal();
            const newObject = {
                material_code: data.material_code,
                material: data.material_name  + ' (Í∞úÎ≥ÑÏ£ºÎ¨∏)',
            };
            this.materialdate.push(newObject); // ÏÉàÎ°úÏö¥ Í∞ùÏ≤¥ Ï∂îÍ∞Ä
            //this.materialdate.sort((a, b) => a.material_code.localeCompare(b.material_code));
            this.materialdate = [...this.materialdate]; //ÏóÖÎç∞Ïù¥Ìä∏ ÏïàÎèºÏÑú Ïû¨Ìï†ÎãπÌï®
        },

        onCellValueChanged(event) {
            //console.log('Ïó¨Í∏∞Ïò¥');
            const { data } = event; //colDef

            // //Îã¨Î†•Ïù¥Î≤§Ìä∏
            // if (colDef.field === 'limit_date') {
            //     // Î≥ÄÍ≤ΩÎêú Í∞í Ï†ÄÏû•
            //     console.log('ÎÇ©Í∏∞Ïùº Î≥ÄÍ≤Ω:', data.limit_date);
            // }   //Îã¨Î†•Ïù¥Î≤§Ìä∏ÎÅù


            // console.log(data.go_qty);
            // console.log(data.go_price);

            if ( data.go_qty || data.go_price ) {
                const quantity = parseFloat(data.go_qty) || 0;
                const price = parseFloat(data.go_price) || 0;

                //data.go_total_price = (quantity * price).toLocaleString()+' Ïõê';
                data.go_total_price = (quantity * price);

                //console.log(data.go_total_price);

                // AG GridÏóê Îç∞Ïù¥ÌÑ∞ Î∞òÏòÅ
                event.api.applyTransaction({ update: [data] });
            }
        },
        poListSum() {
            //console.log('ÎÇò Ïã§Ìñâ ÌñàÏñ¥');
            //console.log('materialdate', this.materialdate);
            //console.log('clientdata', this.clientdata);

            let signer = 'NO';
            let iLoop = this.materialdate.length;
            for(let i=0; i < iLoop; i++){
                //console.log('i',i,' ',this.materialdate[i]['material_code']);

                for(let j=0; j < this.clientdata.length ; j++){
                    //console.log('j',j,' ',this.clientdata[j]['material_code']);
                    console.log(signer);
                    if (signer == 'OK') {
                        console.log(signer);
                        const newObject = {
                            ...this.materialdate[i],
                            com_name: this.clientdata[j]['com_name'],
                            emp_name: this.clientdata[j]['emp_name'],
                            emp_tel: this.clientdata[j]['emp_tel'],
                            client_num: this.clientdata[j]['client_num'],
                        };
                        this.materialdate.push(newObject); // ÏÉàÎ°úÏö¥ Í∞ùÏ≤¥ Ï∂îÍ∞Ä
                    }
                    if(this.materialdate[i]['material_code'] === this.clientdata[j]['material_code'] && !this.materialdate[i]['com_name'] ){
                        console.log('Îß§ÏπòÎêòÏóàÏùå');
                        this.materialdate[i]['com_name'] = this.clientdata[j]['com_name'];
                        this.materialdate[i]['emp_name'] = this.clientdata[j]['emp_name'];
                        this.materialdate[i]['emp_tel'] = this.clientdata[j]['emp_tel'];
                        this.materialdate[i]['client_num'] = this.clientdata[j]['client_num'];
                        signer = 'OK';
                    }
                }
                if (signer == 'OK') {
                    break;
                }
            }
            this.materialdate.sort((a, b) => a.material_code.localeCompare(b.material_code));
            this.materialdate = [...this.materialdate]; //ÏóÖÎç∞Ïù¥Ìä∏ ÏïàÎèºÏÑú Ïû¨Ìï†ÎãπÌï®
            //console.log('UPmaterialdate', this.materialdate);
            //console.log('UPclientdata', this.clientdata);
        },
        //ÎÅùÏù¥Îã§!
        allInput2(){
            const selectedRows = this.gridApi.getSelectedRows();
            console.log(selectedRows);
            if (selectedRows.length > 0) {
                let NOOK = 'OK';
                selectedRows.forEach(val => {
                    if(val.limit_date){
                        const date2 = new Date(val.limit_date);
                        val.limit_date = date2.toISOString().split('T')[0];
                    }
                    if (!val.com_name || !val.go_qty || !val.go_price || !val.limit_date) {
                        this.$notify({ text: 'ÏÑ†ÌÉùÌïú ÌñâÏùò Í∞íÏùÑ Î™®Îëê Ï±ÑÏõåÏ£ºÏÑ∏Ïöî.', type: 'error' }); //title:'Í∞íÏù¥ ÏóÜÏùå', 
                        NOOK = 'NO';
                        return;
                    }
                });
                if(NOOK==='OK'){
                    //this.$notify({ title:'Î∞úÏ£ºÏÑ±Í≥µ', text: 'Î∞úÏ£ºÏ≤òÎ¶¨Ï§ë Ïû†Ïãú Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.', type: 'success' });    //error , success
                    //console.log('Î∞úÏ£ºÏûêÏû¨ Í≤ÄÏÇ¨', selectedRows);
                    this.$emit('goPOlist', selectedRows);
                }
            }else{
                this.$notify({ text: 'ÏÑ†ÌÉùÎêú ÏûêÏû¨Í∞Ä ÏóÜÏäµÎãàÎã§.', type: 'error' }); // title:'Ï£ºÎ¨∏ÏÉùÏÑ±', 
            }
        },

    },  //Î©îÏÜåÎìúÎÅù

};

</script>